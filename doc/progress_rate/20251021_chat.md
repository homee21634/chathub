# 📚 ChatHub 聊天系統 - 交接文件

**專案版本：** v1.0  
**文件日期：** 2025-10-21  
**交接範圍：** 後端 API 開發（Phase 1-3 完成）

---

## 📋 目錄

1. [專案概述](#1-專案概述)
2. [已完成功能](#2-已完成功能)
3. [技術架構](#3-技術架構)
4. [環境配置](#4-環境配置)
5. [資料庫設計](#5-資料庫設計)
6. [API 文件](#6-api-文件)
7. [測試報告](#7-測試報告)
8. [部署指南](#8-部署指南)
9. [未完成項目](#9-未完成項目)
10. [已知問題](#10-已知問題)
11. [開發規範](#11-開發規範)

---

## 1. 專案概述

### 1.1 專案資訊

| 項目 | 內容 |
|-----|------|
| **專案名稱** | ChatHub - 即時通訊系統 |
| **技術棧** | Spring Boot 3.4.10 + MongoDB + PostgreSQL + Redis |
| **開發語言** | Java 17+ |
| **建置工具** | Maven 3.8+ |
| **開發環境** | Docker Compose |

### 1.2 專案結構

```
chatsystem/
├── src/
│   ├── main/
│   │   ├── java/com/chathub/
│   │   │   ├── config/           # 配置類別
│   │   │   │   ├── JwtHandshakeInterceptor.java
│   │   │   │   ├── RedisConfig.java
│   │   │   │   ├── SecurityConfig.java
│   │   │   │   └── WebSocketConfig.java
│   │   │   ├── controller/       # REST API 控制器
│   │   │   │   ├── AuthController.java
│   │   │   │   ├── ConversationController.java
│   │   │   │   └── FriendController.java
│   │   │   ├── dto/              # 資料傳輸物件
│   │   │   │   ├── ApiResponse.java
│   │   │   │   ├── LoginRequest.java
│   │   │   │   ├── RegisterRequest.java
│   │   │   │   └── WebSocketMessage.java
│   │   │   ├── entity/           # 實體類別
│   │   │   │   ├── User.java
│   │   │   │   ├── Friendship.java
│   │   │   │   ├── FriendRequest.java
│   │   │   │   ├── RefreshToken.java
│   │   │   │   ├── Message.java (MongoDB)
│   │   │   │   └── Conversation.java (MongoDB)
│   │   │   ├── handler/          # WebSocket 處理器
│   │   │   │   └── ChatWebSocketHandler.java
│   │   │   ├── repository/       # 資料存取層
│   │   │   │   ├── UserRepository.java
│   │   │   │   ├── FriendshipRepository.java
│   │   │   │   ├── MessageRepository.java
│   │   │   │   └── ConversationRepository.java
│   │   │   ├── security/         # 安全相關
│   │   │   │   ├── JwtTokenProvider.java
│   │   │   │   └── JwtAuthenticationFilter.java
│   │   │   └── service/          # 業務邏輯層
│   │   │       ├── UserService.java
│   │   │       ├── FriendshipService.java
│   │   │       ├── MessageService.java
│   │   │       ├── ConversationService.java
│   │   │       ├── RedisService.java
│   │   │       └── WebSocketSessionManager.java
│   │   └── resources/
│   │       └── application.yml
│   └── test/                     # 測試程式碼
├── docker-compose.yml
└── pom.xml
```

---

## 2. 已完成功能

### ✅ Phase 1: 認證模組（100%）

- [x] 使用者註冊（帳號唯一性驗證、密碼強度驗證）
- [x] 使用者登入（JWT Token、登入失敗限制）
- [x] Token 刷新機制（Access Token + Refresh Token）
- [x] 使用者登出（Token 黑名單）
- [x] JWT 過濾器（自動驗證 API 請求）

### ✅ Phase 2: 好友系統（100%）

- [x] 發送好友請求
- [x] 查看收到的請求
- [x] 接受/拒絕好友請求
- [x] 好友列表查詢
- [x] 刪除好友
- [x] 線上狀態查詢（Redis）

### ✅ Phase 3: 聊天功能（100%）

- [x] WebSocket 連線建立（JWT 驗證）
- [x] 即時訊息發送與接收
- [x] 訊息儲存（MongoDB）
- [x] 對話元資料管理（Conversation）
- [x] 訊息去重機制（clientMessageId）
- [x] 正在輸入提示
- [x] 訊息已讀回執
- [x] 歷史訊息查詢（分頁）
- [x] 未讀訊息統計
- [x] WebSocket 連線管理

---

## 3. 技術架構

### 3.1 系統架構圖

```
┌─────────────────────────────────────────────────┐
│                 Client (未實作)                  │
│         React / WebSocket Client                │
└──────────────────┬──────────────────────────────┘
                   │ HTTPS / WSS
                   ▼
┌─────────────────────────────────────────────────┐
│              Spring Boot Backend                │
│  ┌──────────────────────────────────────────┐  │
│  │  REST API Controllers                    │  │
│  │  - AuthController                        │  │
│  │  - FriendController                      │  │
│  │  - ConversationController                │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │  WebSocket Handler                       │  │
│  │  - ChatWebSocketHandler                  │  │
│  │  - WebSocketSessionManager               │  │
│  └──────────────────────────────────────────┘  │
│  ┌──────────────────────────────────────────┐  │
│  │  Service Layer                           │  │
│  │  - MessageService                        │  │
│  │  - ConversationService                   │  │
│  │  - FriendshipService                     │  │
│  └──────────────────────────────────────────┘  │
└───────┬────────────┬────────────┬──────────────┘
        │            │            │
        ▼            ▼            ▼
┌──────────┐  ┌──────────┐  ┌──────────┐
│PostgreSQL│  │  Redis   │  │ MongoDB  │
│ (用戶)   │  │ (快取)   │  │ (訊息)   │
└──────────┘  └──────────┘  └──────────┘
```

### 3.2 技術選型理由

| 技術 | 選型理由 |
|-----|---------|
| **PostgreSQL** | 關聯式資料，適合使用者、好友關係等強一致性需求 |
| **MongoDB** | 文件型資料庫，適合高寫入的訊息資料，彈性 Schema |
| **Redis** | 極快的讀寫速度，適合線上狀態、訊息快取 |
| **WebSocket** | 雙向即時通訊，低延遲 |
| **JWT** | 無狀態認證，易於水平擴展 |

---

## 4. 環境配置

### 4.1 本地開發環境

#### 前置需求

- Java 17+
- Maven 3.8+
- Docker & Docker Compose

#### 啟動步驟

```bash
# 1. 啟動資料庫（PostgreSQL、MongoDB、Redis）
docker-compose up -d

# 2. 編譯專案
mvn clean install

# 3. 啟動應用程式
mvn spring-boot:run

# 4. 驗證服務
curl http://localhost:8080/actuator/health
```

### 4.2 Docker Compose 配置

**服務清單：**

| 服務 | 端口 | 帳密 |
|-----|------|------|
| PostgreSQL | 5433 | postgres / postgres123 |
| MongoDB | 27017 | admin / admin123 |
| Redis | 6379 | (無密碼) |

**docker-compose.yml** 位置：專案根目錄

### 4.3 application.yml 配置

```yaml
# 關鍵配置項目
server:
  port: 8080

spring:
  datasource:
    url: jdbc:postgresql://localhost:5433/chatsystem
    username: postgres
    password: postgres123
  
  data:
    mongodb:
      uri: mongodb://admin:admin123@localhost:27017/chathub?authSource=admin
  
  data:
    redis:
      host: localhost
      port: 6379

jwt:
  secret: your-secret-key-here-min-512-bits
  access-token-expiration: 3600000    # 1小時
  refresh-token-expiration: 604800000  # 7天
```

---

## 5. 資料庫設計

### 5.1 PostgreSQL Schema

#### users 表

```sql
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(20) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_online BOOLEAN NOT NULL DEFAULT FALSE
);
```

#### friendships 表

```sql
CREATE TABLE friendships (
    friendship_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    friend_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, friend_id)
);
```

#### friend_requests 表

```sql
CREATE TABLE friend_requests (
    request_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    from_user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    to_user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    responded_at TIMESTAMP
);
```

#### refresh_tokens 表

```sql
CREATE TABLE refresh_tokens (
    token_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    revoked_at TIMESTAMP
);
```

### 5.2 MongoDB Collections

#### messages

```javascript
{
  "_id": ObjectId("..."),
  "messageId": "uuid-string",
  "conversationId": "uuid1_uuid2",
  "senderId": "uuid-string",
  "senderUsername": "alice",
  "recipientId": "uuid-string",
  "content": "訊息內容",
  "timestamp": ISODate("..."),
  "isRead": false,
  "readAt": null,
  "clientMessageId": "client-uuid",
  "createdAt": ISODate("...")
}

// 索引
db.messages.createIndex({ "conversationId": 1, "timestamp": -1 })
db.messages.createIndex({ "recipientId": 1, "isRead": 1 })
db.messages.createIndex({ "clientMessageId": 1 }, { unique: true, sparse: true })
```

#### conversations

```javascript
{
  "_id": ObjectId("..."),
  "conversationId": "uuid1_uuid2",
  "participants": ["uuid1", "uuid2"],
  "lastMessage": {
    "messageId": "uuid",
    "content": "最後訊息",
    "senderId": "uuid",
    "timestamp": ISODate("...")
  },
  "unreadCounts": {
    "uuid1": 0,
    "uuid2": 3
  },
  "createdAt": ISODate("..."),
  "updatedAt": ISODate("...")
}

// 索引
db.conversations.createIndex({ "conversationId": 1 }, { unique: true })
db.conversations.createIndex({ "participants": 1, "updatedAt": -1 })
```

### 5.3 Redis 資料結構

| Key 格式 | 類型 | TTL | 用途 |
|---------|------|-----|------|
| `user:online:{userId}` | String | 1小時 | 線上狀態 |
| `login:attempt:{username}` | String | 15分鐘 | 登入失敗計數 |
| `token:blacklist:{jti}` | String | Token有效期 | Token黑名單 |

---

## 6. API 文件

### 6.1 認證 API

#### POST /api/v1/auth/register

**功能：** 註冊新使用者

**Request Body：**
```json
{
  "username": "alice",
  "password": "Password123!"
}
```

**Response：**
```json
{
  "success": true,
  "message": "註冊成功",
  "data": null
}
```

#### POST /api/v1/auth/login

**功能：** 使用者登入

**Request Body：**
```json
{
  "username": "alice",
  "password": "Password123!",
  "rememberMe": true
}
```

**Response：**
```json
{
  "success": true,
  "message": "登入成功",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
    "userId": "uuid",
    "username": "alice"
  }
}
```

#### POST /api/v1/auth/refresh

**功能：** 刷新 Access Token

**Request Body：**
```json
{
  "refreshToken": "eyJhbGciOiJIUzUxMiJ9..."
}
```

**Response：**
```json
{
  "success": true,
  "data": {
    "accessToken": "new-access-token",
    "refreshToken": "new-refresh-token"
  }
}
```

#### POST /api/v1/auth/logout

**功能：** 使用者登出

**Headers：** `Authorization: Bearer {token}`

**Response：**
```json
{
  "success": true,
  "message": "登出成功"
}
```

### 6.2 好友 API

#### POST /api/v1/friends/requests

**功能：** 發送好友請求

**Headers：** `Authorization: Bearer {token}`

**Request Body：**
```json
{
  "toUserId": "target-user-uuid"
}
```

#### GET /api/v1/friends/requests/received

**功能：** 查看收到的請求

**Headers：** `Authorization: Bearer {token}`

#### PUT /api/v1/friends/requests/{requestId}

**功能：** 處理好友請求

**Request Body：**
```json
{
  "action": "ACCEPT"  // or "REJECT"
}
```

#### GET /api/v1/friends

**功能：** 查看好友列表

**Headers：** `Authorization: Bearer {token}`

### 6.3 聊天 API

#### GET /api/v1/conversations

**功能：** 查詢對話列表

**Parameters：** `page=0&size=20`

#### GET /api/v1/conversations/{conversationId}/messages

**功能：** 查詢歷史訊息

**Parameters：** `page=0&size=20`

#### PUT /api/v1/conversations/{conversationId}/read

**功能：** 標記訊息為已讀

#### GET /api/v1/conversations/unread-count

**功能：** 查詢未讀訊息總數

### 6.4 WebSocket API

**連線 URL：** `ws://localhost:8080/ws/chat?token={access-token}`

#### 客戶端 → 伺服器

**發送訊息：**
```json
{
  "type": "SEND_MESSAGE",
  "payload": {
    "recipientId": "uuid",
    "content": "訊息內容",
    "clientMessageId": "client-uuid"
  },
  "timestamp": "2025-10-21T10:00:00Z"
}
```

**正在輸入：**
```json
{
  "type": "TYPING_START",
  "payload": {
    "recipientId": "uuid"
  },
  "timestamp": "..."
}
```

**標記已讀：**
```json
{
  "type": "MESSAGE_READ",
  "payload": {
    "conversationId": "uuid1_uuid2",
    "messageId": "uuid"
  },
  "timestamp": "..."
}
```

#### 伺服器 → 客戶端

**新訊息：**
```json
{
  "type": "NEW_MESSAGE",
  "payload": {
    "messageId": "uuid",
    "conversationId": "uuid1_uuid2",
    "senderId": "uuid",
    "senderUsername": "alice",
    "content": "訊息內容",
    "timestamp": "..."
  },
  "timestamp": "..."
}
```

**訊息送達確認：**
```json
{
  "type": "MESSAGE_DELIVERED",
  "payload": {
    "messageId": "server-uuid",
    "clientMessageId": "client-uuid"
  },
  "timestamp": "..."
}
```

---

## 7. 測試報告

### 7.1 測試覆蓋率

| 模組 | 測試類別 | 測試數 | 通過率 |
|-----|---------|--------|--------|
| MongoDB | MongoDBConnectionTest | 5 | 100% |
| MessageService | MessageServiceTest | 5 | 100% |
| ConversationService | ConversationServiceTest | 5 | 100% |
| REST API | ConversationControllerTest | 6 | 100% |

### 7.2 執行測試

```bash
# 執行所有測試
mvn test

# 執行特定測試
mvn test -Dtest=MessageServiceTest

# 查看測試報告
open target/surefire-reports/index.html
```

---

## 8. 部署指南

### 8.1 本地部署

```bash
# 1. 建置 JAR
mvn clean package

# 2. 執行
java -jar target/chatsystem-1.0.0.jar
```

### 8.2 Docker 部署（未完成）

**TODO：** 需要建立 Dockerfile

```dockerfile
# 範例 Dockerfile
FROM openjdk:17-jdk-slim
COPY target/*.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

### 8.3 Kubernetes 部署（未完成）

**TODO：** 需要建立 K8s YAML 配置

---

## 9. 未完成項目

### ❌ Phase 4: Redis 快取與 Pub/Sub（0%）

- [ ] 訊息快取（最近100則）
- [ ] Redis Pub/Sub 跨 Pod 通訊
- [ ] 未讀數快取優化

### ❌ 前端應用（0%）

- [ ] React 專案初始化
- [ ] 登入/註冊頁面
- [ ] 好友列表 UI
- [ ] 聊天介面
- [ ] WebSocket 客戶端

### ❌ 進階功能

- [ ] 群組聊天
- [ ] 檔案傳輸
- [ ] 語音/視訊通話
- [ ] 推送通知

---

## 10. 已知問題

### 10.1 功能限制

1. **單一 Pod 限制：** 目前 WebSocket 連線僅支援單一 Pod，未實作 Redis Pub/Sub
2. **訊息快取：** 未實作 Redis 快取，歷史訊息查詢直接從 MongoDB
3. **檔案上傳：** 不支援圖片、檔案傳輸
4. **未讀數效能：** 未讀數查詢未使用快取，使用者過多時可能較慢

### 10.2 測試環境問題

1. **測試資料清理：** 測試完成後需手動清理資料庫
2. **並發測試：** 未進行壓力測試

---

## 11. 開發規範

### 11.1 命名規範

- **類別名稱：** PascalCase（UserService）
- **方法名稱：** camelCase（saveMessage）
- **常數名稱：** UPPER_SNAKE_CASE（MAX_LOGIN_ATTEMPTS）
- **資料庫表名：** snake_case（friend_requests）

### 11.2 程式碼風格

- 使用 **Lombok** 減少樣板程式碼
- 使用 **Builder Pattern** 建立物件
- 善用 **@Transactional** 管理交易
- Controller 只做參數驗證，業務邏輯放 Service

### 11.3 Git 規範

```bash
# Commit 訊息格式
[類型] 簡短描述

feat: 新增好友列表查詢 API
fix: 修正訊息去重機制
docs: 更新 API 文件
test: 新增 MessageService 測試
```

---

## 12. 重要注意事項

### 12.1 安全性

1. **JWT Secret：** 生產環境必須使用強密鑰（至少 512 bits）
2. **密碼強度：** 已實作密碼強度驗證，不可移除
3. **CORS 設定：** 生產環境需限制來源網域
4. **Rate Limiting：** 登入 API 已有失敗次數限制

### 12.2 效能優化

1. **資料庫索引：** 已建立必要索引，不可刪除
2. **分頁查詢：** 所有列表查詢都使用分頁
3. **WebSocket 心跳：** 客戶端需每 30 秒發送 PING

### 12.3 故障排除

**常見問題：**

1. **WebSocket 連線失敗**
    - 檢查 Token 是否有效
    - 確認 URL 格式：`ws://localhost:8080/ws/chat?token=xxx`

2. **資料庫連線失敗**
    - 確認 Docker 容器已啟動：`docker-compose ps`
    - 檢查端口是否被佔用

3. **測試失敗**
    - 清理資料庫：`docker-compose down -v`
    - 重新啟動：`docker-compose up -d`

---

## 13. 聯絡資訊

**交接人員：** Claude (AI Assistant)  
**交接日期：** 2025-10-21  
**專案狀態：** 開發中（後端 API 已完成 60%）

**下一步建議：**
1. 實作 Redis Pub/Sub（Phase 4）
2. 開發前端應用
3. 進行壓力測試
4. 部署至測試環境

---

**文件結束** 📄