# ğŸ“š ChatHub èŠå¤©ç³»çµ± - äº¤æ¥æ–‡ä»¶

**å°ˆæ¡ˆç‰ˆæœ¬ï¼š** v1.0  
**æ–‡ä»¶æ—¥æœŸï¼š** 2025-10-21  
**äº¤æ¥ç¯„åœï¼š** å¾Œç«¯ API é–‹ç™¼ï¼ˆPhase 1-3 å®Œæˆï¼‰

---

## ğŸ“‹ ç›®éŒ„

1. [å°ˆæ¡ˆæ¦‚è¿°](#1-å°ˆæ¡ˆæ¦‚è¿°)
2. [å·²å®ŒæˆåŠŸèƒ½](#2-å·²å®ŒæˆåŠŸèƒ½)
3. [æŠ€è¡“æ¶æ§‹](#3-æŠ€è¡“æ¶æ§‹)
4. [ç’°å¢ƒé…ç½®](#4-ç’°å¢ƒé…ç½®)
5. [è³‡æ–™åº«è¨­è¨ˆ](#5-è³‡æ–™åº«è¨­è¨ˆ)
6. [API æ–‡ä»¶](#6-api-æ–‡ä»¶)
7. [æ¸¬è©¦å ±å‘Š](#7-æ¸¬è©¦å ±å‘Š)
8. [éƒ¨ç½²æŒ‡å—](#8-éƒ¨ç½²æŒ‡å—)
9. [æœªå®Œæˆé …ç›®](#9-æœªå®Œæˆé …ç›®)
10. [å·²çŸ¥å•é¡Œ](#10-å·²çŸ¥å•é¡Œ)
11. [é–‹ç™¼è¦ç¯„](#11-é–‹ç™¼è¦ç¯„)

---

## 1. å°ˆæ¡ˆæ¦‚è¿°

### 1.1 å°ˆæ¡ˆè³‡è¨Š

| é …ç›® | å…§å®¹ |
|-----|------|
| **å°ˆæ¡ˆåç¨±** | ChatHub - å³æ™‚é€šè¨Šç³»çµ± |
| **æŠ€è¡“æ£§** | Spring Boot 3.4.10 + MongoDB + PostgreSQL + Redis |
| **é–‹ç™¼èªè¨€** | Java 17+ |
| **å»ºç½®å·¥å…·** | Maven 3.8+ |
| **é–‹ç™¼ç’°å¢ƒ** | Docker Compose |

### 1.2 å°ˆæ¡ˆçµæ§‹

```
chatsystem/
â”œâ”€â”€ src/
â”‚   â”œâ”€â”€ main/
â”‚   â”‚   â”œâ”€â”€ java/com/chathub/
â”‚   â”‚   â”‚   â”œâ”€â”€ config/           # é…ç½®é¡åˆ¥
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JwtHandshakeInterceptor.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RedisConfig.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ SecurityConfig.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WebSocketConfig.java
â”‚   â”‚   â”‚   â”œâ”€â”€ controller/       # REST API æ§åˆ¶å™¨
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ AuthController.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ConversationController.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ FriendController.java
â”‚   â”‚   â”‚   â”œâ”€â”€ dto/              # è³‡æ–™å‚³è¼¸ç‰©ä»¶
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ ApiResponse.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ LoginRequest.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RegisterRequest.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ WebSocketMessage.java
â”‚   â”‚   â”‚   â”œâ”€â”€ entity/           # å¯¦é«”é¡åˆ¥
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ User.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Friendship.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FriendRequest.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ RefreshToken.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ Message.java (MongoDB)
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ Conversation.java (MongoDB)
â”‚   â”‚   â”‚   â”œâ”€â”€ handler/          # WebSocket è™•ç†å™¨
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ChatWebSocketHandler.java
â”‚   â”‚   â”‚   â”œâ”€â”€ repository/       # è³‡æ–™å­˜å–å±¤
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ UserRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ FriendshipRepository.java
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ MessageRepository.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ ConversationRepository.java
â”‚   â”‚   â”‚   â”œâ”€â”€ security/         # å®‰å…¨ç›¸é—œ
â”‚   â”‚   â”‚   â”‚   â”œâ”€â”€ JwtTokenProvider.java
â”‚   â”‚   â”‚   â”‚   â””â”€â”€ JwtAuthenticationFilter.java
â”‚   â”‚   â”‚   â””â”€â”€ service/          # æ¥­å‹™é‚è¼¯å±¤
â”‚   â”‚   â”‚       â”œâ”€â”€ UserService.java
â”‚   â”‚   â”‚       â”œâ”€â”€ FriendshipService.java
â”‚   â”‚   â”‚       â”œâ”€â”€ MessageService.java
â”‚   â”‚   â”‚       â”œâ”€â”€ ConversationService.java
â”‚   â”‚   â”‚       â”œâ”€â”€ RedisService.java
â”‚   â”‚   â”‚       â””â”€â”€ WebSocketSessionManager.java
â”‚   â”‚   â””â”€â”€ resources/
â”‚   â”‚       â””â”€â”€ application.yml
â”‚   â””â”€â”€ test/                     # æ¸¬è©¦ç¨‹å¼ç¢¼
â”œâ”€â”€ docker-compose.yml
â””â”€â”€ pom.xml
```

---

## 2. å·²å®ŒæˆåŠŸèƒ½

### âœ… Phase 1: èªè­‰æ¨¡çµ„ï¼ˆ100%ï¼‰

- [x] ä½¿ç”¨è€…è¨»å†Šï¼ˆå¸³è™Ÿå”¯ä¸€æ€§é©—è­‰ã€å¯†ç¢¼å¼·åº¦é©—è­‰ï¼‰
- [x] ä½¿ç”¨è€…ç™»å…¥ï¼ˆJWT Tokenã€ç™»å…¥å¤±æ•—é™åˆ¶ï¼‰
- [x] Token åˆ·æ–°æ©Ÿåˆ¶ï¼ˆAccess Token + Refresh Tokenï¼‰
- [x] ä½¿ç”¨è€…ç™»å‡ºï¼ˆToken é»‘åå–®ï¼‰
- [x] JWT éæ¿¾å™¨ï¼ˆè‡ªå‹•é©—è­‰ API è«‹æ±‚ï¼‰

### âœ… Phase 2: å¥½å‹ç³»çµ±ï¼ˆ100%ï¼‰

- [x] ç™¼é€å¥½å‹è«‹æ±‚
- [x] æŸ¥çœ‹æ”¶åˆ°çš„è«‹æ±‚
- [x] æ¥å—/æ‹’çµ•å¥½å‹è«‹æ±‚
- [x] å¥½å‹åˆ—è¡¨æŸ¥è©¢
- [x] åˆªé™¤å¥½å‹
- [x] ç·šä¸Šç‹€æ…‹æŸ¥è©¢ï¼ˆRedisï¼‰

### âœ… Phase 3: èŠå¤©åŠŸèƒ½ï¼ˆ100%ï¼‰

- [x] WebSocket é€£ç·šå»ºç«‹ï¼ˆJWT é©—è­‰ï¼‰
- [x] å³æ™‚è¨Šæ¯ç™¼é€èˆ‡æ¥æ”¶
- [x] è¨Šæ¯å„²å­˜ï¼ˆMongoDBï¼‰
- [x] å°è©±å…ƒè³‡æ–™ç®¡ç†ï¼ˆConversationï¼‰
- [x] è¨Šæ¯å»é‡æ©Ÿåˆ¶ï¼ˆclientMessageIdï¼‰
- [x] æ­£åœ¨è¼¸å…¥æç¤º
- [x] è¨Šæ¯å·²è®€å›åŸ·
- [x] æ­·å²è¨Šæ¯æŸ¥è©¢ï¼ˆåˆ†é ï¼‰
- [x] æœªè®€è¨Šæ¯çµ±è¨ˆ
- [x] WebSocket é€£ç·šç®¡ç†

---

## 3. æŠ€è¡“æ¶æ§‹

### 3.1 ç³»çµ±æ¶æ§‹åœ–

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                 Client (æœªå¯¦ä½œ)                  â”‚
â”‚         React / WebSocket Client                â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                   â”‚ HTTPS / WSS
                   â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚              Spring Boot Backend                â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  REST API Controllers                    â”‚  â”‚
â”‚  â”‚  - AuthController                        â”‚  â”‚
â”‚  â”‚  - FriendController                      â”‚  â”‚
â”‚  â”‚  - ConversationController                â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  WebSocket Handler                       â”‚  â”‚
â”‚  â”‚  - ChatWebSocketHandler                  â”‚  â”‚
â”‚  â”‚  - WebSocketSessionManager               â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â”‚  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”‚
â”‚  â”‚  Service Layer                           â”‚  â”‚
â”‚  â”‚  - MessageService                        â”‚  â”‚
â”‚  â”‚  - ConversationService                   â”‚  â”‚
â”‚  â”‚  - FriendshipService                     â”‚  â”‚
â”‚  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚            â”‚            â”‚
        â–¼            â–¼            â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”  â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚PostgreSQLâ”‚  â”‚  Redis   â”‚  â”‚ MongoDB  â”‚
â”‚ (ç”¨æˆ¶)   â”‚  â”‚ (å¿«å–)   â”‚  â”‚ (è¨Šæ¯)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜  â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### 3.2 æŠ€è¡“é¸å‹ç†ç”±

| æŠ€è¡“ | é¸å‹ç†ç”± |
|-----|---------|
| **PostgreSQL** | é—œè¯å¼è³‡æ–™ï¼Œé©åˆä½¿ç”¨è€…ã€å¥½å‹é—œä¿‚ç­‰å¼·ä¸€è‡´æ€§éœ€æ±‚ |
| **MongoDB** | æ–‡ä»¶å‹è³‡æ–™åº«ï¼Œé©åˆé«˜å¯«å…¥çš„è¨Šæ¯è³‡æ–™ï¼Œå½ˆæ€§ Schema |
| **Redis** | æ¥µå¿«çš„è®€å¯«é€Ÿåº¦ï¼Œé©åˆç·šä¸Šç‹€æ…‹ã€è¨Šæ¯å¿«å– |
| **WebSocket** | é›™å‘å³æ™‚é€šè¨Šï¼Œä½å»¶é² |
| **JWT** | ç„¡ç‹€æ…‹èªè­‰ï¼Œæ˜“æ–¼æ°´å¹³æ“´å±• |

---

## 4. ç’°å¢ƒé…ç½®

### 4.1 æœ¬åœ°é–‹ç™¼ç’°å¢ƒ

#### å‰ç½®éœ€æ±‚

- Java 17+
- Maven 3.8+
- Docker & Docker Compose

#### å•Ÿå‹•æ­¥é©Ÿ

```bash
# 1. å•Ÿå‹•è³‡æ–™åº«ï¼ˆPostgreSQLã€MongoDBã€Redisï¼‰
docker-compose up -d

# 2. ç·¨è­¯å°ˆæ¡ˆ
mvn clean install

# 3. å•Ÿå‹•æ‡‰ç”¨ç¨‹å¼
mvn spring-boot:run

# 4. é©—è­‰æœå‹™
curl http://localhost:8080/actuator/health
```

### 4.2 Docker Compose é…ç½®

**æœå‹™æ¸…å–®ï¼š**

| æœå‹™ | ç«¯å£ | å¸³å¯† |
|-----|------|------|
| PostgreSQL | 5433 | postgres / postgres123 |
| MongoDB | 27017 | admin / admin123 |
| Redis | 6379 | (ç„¡å¯†ç¢¼) |

**docker-compose.yml** ä½ç½®ï¼šå°ˆæ¡ˆæ ¹ç›®éŒ„

### 4.3 application.yml é…ç½®

```yaml
# é—œéµé…ç½®é …ç›®
server:
  port: 8080

spring:
  datasource:
    url: jdbc:postgresql://localhost:5433/chatsystem
    username: postgres
    password: postgres123
  
  data:
    mongodb:
      uri: mongodb://admin:admin123@localhost:27017/chathub?authSource=admin
  
  data:
    redis:
      host: localhost
      port: 6379

jwt:
  secret: your-secret-key-here-min-512-bits
  access-token-expiration: 3600000    # 1å°æ™‚
  refresh-token-expiration: 604800000  # 7å¤©
```

---

## 5. è³‡æ–™åº«è¨­è¨ˆ

### 5.1 PostgreSQL Schema

#### users è¡¨

```sql
CREATE TABLE users (
    user_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    username VARCHAR(20) NOT NULL UNIQUE,
    password_hash VARCHAR(255) NOT NULL,
    version BIGINT NOT NULL DEFAULT 0,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    last_login_at TIMESTAMP,
    is_active BOOLEAN NOT NULL DEFAULT TRUE,
    is_online BOOLEAN NOT NULL DEFAULT FALSE
);
```

#### friendships è¡¨

```sql
CREATE TABLE friendships (
    friendship_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    friend_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(user_id, friend_id)
);
```

#### friend_requests è¡¨

```sql
CREATE TABLE friend_requests (
    request_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    from_user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    to_user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    status VARCHAR(20) NOT NULL DEFAULT 'PENDING',
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    responded_at TIMESTAMP
);
```

#### refresh_tokens è¡¨

```sql
CREATE TABLE refresh_tokens (
    token_id UUID PRIMARY KEY DEFAULT uuid_generate_v4(),
    user_id UUID NOT NULL REFERENCES users(user_id) ON DELETE CASCADE,
    token_hash VARCHAR(255) NOT NULL UNIQUE,
    expires_at TIMESTAMP NOT NULL,
    created_at TIMESTAMP NOT NULL DEFAULT CURRENT_TIMESTAMP,
    revoked_at TIMESTAMP
);
```

### 5.2 MongoDB Collections

#### messages

```javascript
{
  "_id": ObjectId("..."),
  "messageId": "uuid-string",
  "conversationId": "uuid1_uuid2",
  "senderId": "uuid-string",
  "senderUsername": "alice",
  "recipientId": "uuid-string",
  "content": "è¨Šæ¯å…§å®¹",
  "timestamp": ISODate("..."),
  "isRead": false,
  "readAt": null,
  "clientMessageId": "client-uuid",
  "createdAt": ISODate("...")
}

// ç´¢å¼•
db.messages.createIndex({ "conversationId": 1, "timestamp": -1 })
db.messages.createIndex({ "recipientId": 1, "isRead": 1 })
db.messages.createIndex({ "clientMessageId": 1 }, { unique: true, sparse: true })
```

#### conversations

```javascript
{
  "_id": ObjectId("..."),
  "conversationId": "uuid1_uuid2",
  "participants": ["uuid1", "uuid2"],
  "lastMessage": {
    "messageId": "uuid",
    "content": "æœ€å¾Œè¨Šæ¯",
    "senderId": "uuid",
    "timestamp": ISODate("...")
  },
  "unreadCounts": {
    "uuid1": 0,
    "uuid2": 3
  },
  "createdAt": ISODate("..."),
  "updatedAt": ISODate("...")
}

// ç´¢å¼•
db.conversations.createIndex({ "conversationId": 1 }, { unique: true })
db.conversations.createIndex({ "participants": 1, "updatedAt": -1 })
```

### 5.3 Redis è³‡æ–™çµæ§‹

| Key æ ¼å¼ | é¡å‹ | TTL | ç”¨é€” |
|---------|------|-----|------|
| `user:online:{userId}` | String | 1å°æ™‚ | ç·šä¸Šç‹€æ…‹ |
| `login:attempt:{username}` | String | 15åˆ†é˜ | ç™»å…¥å¤±æ•—è¨ˆæ•¸ |
| `token:blacklist:{jti}` | String | Tokenæœ‰æ•ˆæœŸ | Tokené»‘åå–® |

---

## 6. API æ–‡ä»¶

### 6.1 èªè­‰ API

#### POST /api/v1/auth/register

**åŠŸèƒ½ï¼š** è¨»å†Šæ–°ä½¿ç”¨è€…

**Request Bodyï¼š**
```json
{
  "username": "alice",
  "password": "Password123!"
}
```

**Responseï¼š**
```json
{
  "success": true,
  "message": "è¨»å†ŠæˆåŠŸ",
  "data": null
}
```

#### POST /api/v1/auth/login

**åŠŸèƒ½ï¼š** ä½¿ç”¨è€…ç™»å…¥

**Request Bodyï¼š**
```json
{
  "username": "alice",
  "password": "Password123!",
  "rememberMe": true
}
```

**Responseï¼š**
```json
{
  "success": true,
  "message": "ç™»å…¥æˆåŠŸ",
  "data": {
    "accessToken": "eyJhbGciOiJIUzUxMiJ9...",
    "refreshToken": "eyJhbGciOiJIUzUxMiJ9...",
    "userId": "uuid",
    "username": "alice"
  }
}
```

#### POST /api/v1/auth/refresh

**åŠŸèƒ½ï¼š** åˆ·æ–° Access Token

**Request Bodyï¼š**
```json
{
  "refreshToken": "eyJhbGciOiJIUzUxMiJ9..."
}
```

**Responseï¼š**
```json
{
  "success": true,
  "data": {
    "accessToken": "new-access-token",
    "refreshToken": "new-refresh-token"
  }
}
```

#### POST /api/v1/auth/logout

**åŠŸèƒ½ï¼š** ä½¿ç”¨è€…ç™»å‡º

**Headersï¼š** `Authorization: Bearer {token}`

**Responseï¼š**
```json
{
  "success": true,
  "message": "ç™»å‡ºæˆåŠŸ"
}
```

### 6.2 å¥½å‹ API

#### POST /api/v1/friends/requests

**åŠŸèƒ½ï¼š** ç™¼é€å¥½å‹è«‹æ±‚

**Headersï¼š** `Authorization: Bearer {token}`

**Request Bodyï¼š**
```json
{
  "toUserId": "target-user-uuid"
}
```

#### GET /api/v1/friends/requests/received

**åŠŸèƒ½ï¼š** æŸ¥çœ‹æ”¶åˆ°çš„è«‹æ±‚

**Headersï¼š** `Authorization: Bearer {token}`

#### PUT /api/v1/friends/requests/{requestId}

**åŠŸèƒ½ï¼š** è™•ç†å¥½å‹è«‹æ±‚

**Request Bodyï¼š**
```json
{
  "action": "ACCEPT"  // or "REJECT"
}
```

#### GET /api/v1/friends

**åŠŸèƒ½ï¼š** æŸ¥çœ‹å¥½å‹åˆ—è¡¨

**Headersï¼š** `Authorization: Bearer {token}`

### 6.3 èŠå¤© API

#### GET /api/v1/conversations

**åŠŸèƒ½ï¼š** æŸ¥è©¢å°è©±åˆ—è¡¨

**Parametersï¼š** `page=0&size=20`

#### GET /api/v1/conversations/{conversationId}/messages

**åŠŸèƒ½ï¼š** æŸ¥è©¢æ­·å²è¨Šæ¯

**Parametersï¼š** `page=0&size=20`

#### PUT /api/v1/conversations/{conversationId}/read

**åŠŸèƒ½ï¼š** æ¨™è¨˜è¨Šæ¯ç‚ºå·²è®€

#### GET /api/v1/conversations/unread-count

**åŠŸèƒ½ï¼š** æŸ¥è©¢æœªè®€è¨Šæ¯ç¸½æ•¸

### 6.4 WebSocket API

**é€£ç·š URLï¼š** `ws://localhost:8080/ws/chat?token={access-token}`

#### å®¢æˆ¶ç«¯ â†’ ä¼ºæœå™¨

**ç™¼é€è¨Šæ¯ï¼š**
```json
{
  "type": "SEND_MESSAGE",
  "payload": {
    "recipientId": "uuid",
    "content": "è¨Šæ¯å…§å®¹",
    "clientMessageId": "client-uuid"
  },
  "timestamp": "2025-10-21T10:00:00Z"
}
```

**æ­£åœ¨è¼¸å…¥ï¼š**
```json
{
  "type": "TYPING_START",
  "payload": {
    "recipientId": "uuid"
  },
  "timestamp": "..."
}
```

**æ¨™è¨˜å·²è®€ï¼š**
```json
{
  "type": "MESSAGE_READ",
  "payload": {
    "conversationId": "uuid1_uuid2",
    "messageId": "uuid"
  },
  "timestamp": "..."
}
```

#### ä¼ºæœå™¨ â†’ å®¢æˆ¶ç«¯

**æ–°è¨Šæ¯ï¼š**
```json
{
  "type": "NEW_MESSAGE",
  "payload": {
    "messageId": "uuid",
    "conversationId": "uuid1_uuid2",
    "senderId": "uuid",
    "senderUsername": "alice",
    "content": "è¨Šæ¯å…§å®¹",
    "timestamp": "..."
  },
  "timestamp": "..."
}
```

**è¨Šæ¯é€é”ç¢ºèªï¼š**
```json
{
  "type": "MESSAGE_DELIVERED",
  "payload": {
    "messageId": "server-uuid",
    "clientMessageId": "client-uuid"
  },
  "timestamp": "..."
}
```

---

## 7. æ¸¬è©¦å ±å‘Š

### 7.1 æ¸¬è©¦è¦†è“‹ç‡

| æ¨¡çµ„ | æ¸¬è©¦é¡åˆ¥ | æ¸¬è©¦æ•¸ | é€šéç‡ |
|-----|---------|--------|--------|
| MongoDB | MongoDBConnectionTest | 5 | 100% |
| MessageService | MessageServiceTest | 5 | 100% |
| ConversationService | ConversationServiceTest | 5 | 100% |
| REST API | ConversationControllerTest | 6 | 100% |

### 7.2 åŸ·è¡Œæ¸¬è©¦

```bash
# åŸ·è¡Œæ‰€æœ‰æ¸¬è©¦
mvn test

# åŸ·è¡Œç‰¹å®šæ¸¬è©¦
mvn test -Dtest=MessageServiceTest

# æŸ¥çœ‹æ¸¬è©¦å ±å‘Š
open target/surefire-reports/index.html
```

---

## 8. éƒ¨ç½²æŒ‡å—

### 8.1 æœ¬åœ°éƒ¨ç½²

```bash
# 1. å»ºç½® JAR
mvn clean package

# 2. åŸ·è¡Œ
java -jar target/chatsystem-1.0.0.jar
```

### 8.2 Docker éƒ¨ç½²ï¼ˆæœªå®Œæˆï¼‰

**TODOï¼š** éœ€è¦å»ºç«‹ Dockerfile

```dockerfile
# ç¯„ä¾‹ Dockerfile
FROM openjdk:17-jdk-slim
COPY target/*.jar app.jar
ENTRYPOINT ["java","-jar","/app.jar"]
```

### 8.3 Kubernetes éƒ¨ç½²ï¼ˆæœªå®Œæˆï¼‰

**TODOï¼š** éœ€è¦å»ºç«‹ K8s YAML é…ç½®

---

## 9. æœªå®Œæˆé …ç›®

### âŒ Phase 4: Redis å¿«å–èˆ‡ Pub/Subï¼ˆ0%ï¼‰

- [ ] è¨Šæ¯å¿«å–ï¼ˆæœ€è¿‘100å‰‡ï¼‰
- [ ] Redis Pub/Sub è·¨ Pod é€šè¨Š
- [ ] æœªè®€æ•¸å¿«å–å„ªåŒ–

### âŒ å‰ç«¯æ‡‰ç”¨ï¼ˆ0%ï¼‰

- [ ] React å°ˆæ¡ˆåˆå§‹åŒ–
- [ ] ç™»å…¥/è¨»å†Šé é¢
- [ ] å¥½å‹åˆ—è¡¨ UI
- [ ] èŠå¤©ä»‹é¢
- [ ] WebSocket å®¢æˆ¶ç«¯

### âŒ é€²éšåŠŸèƒ½

- [ ] ç¾¤çµ„èŠå¤©
- [ ] æª”æ¡ˆå‚³è¼¸
- [ ] èªéŸ³/è¦–è¨Šé€šè©±
- [ ] æ¨é€é€šçŸ¥

---

## 10. å·²çŸ¥å•é¡Œ

### 10.1 åŠŸèƒ½é™åˆ¶

1. **å–®ä¸€ Pod é™åˆ¶ï¼š** ç›®å‰ WebSocket é€£ç·šåƒ…æ”¯æ´å–®ä¸€ Podï¼Œæœªå¯¦ä½œ Redis Pub/Sub
2. **è¨Šæ¯å¿«å–ï¼š** æœªå¯¦ä½œ Redis å¿«å–ï¼Œæ­·å²è¨Šæ¯æŸ¥è©¢ç›´æ¥å¾ MongoDB
3. **æª”æ¡ˆä¸Šå‚³ï¼š** ä¸æ”¯æ´åœ–ç‰‡ã€æª”æ¡ˆå‚³è¼¸
4. **æœªè®€æ•¸æ•ˆèƒ½ï¼š** æœªè®€æ•¸æŸ¥è©¢æœªä½¿ç”¨å¿«å–ï¼Œä½¿ç”¨è€…éå¤šæ™‚å¯èƒ½è¼ƒæ…¢

### 10.2 æ¸¬è©¦ç’°å¢ƒå•é¡Œ

1. **æ¸¬è©¦è³‡æ–™æ¸…ç†ï¼š** æ¸¬è©¦å®Œæˆå¾Œéœ€æ‰‹å‹•æ¸…ç†è³‡æ–™åº«
2. **ä¸¦ç™¼æ¸¬è©¦ï¼š** æœªé€²è¡Œå£“åŠ›æ¸¬è©¦

---

## 11. é–‹ç™¼è¦ç¯„

### 11.1 å‘½åè¦ç¯„

- **é¡åˆ¥åç¨±ï¼š** PascalCaseï¼ˆUserServiceï¼‰
- **æ–¹æ³•åç¨±ï¼š** camelCaseï¼ˆsaveMessageï¼‰
- **å¸¸æ•¸åç¨±ï¼š** UPPER_SNAKE_CASEï¼ˆMAX_LOGIN_ATTEMPTSï¼‰
- **è³‡æ–™åº«è¡¨åï¼š** snake_caseï¼ˆfriend_requestsï¼‰

### 11.2 ç¨‹å¼ç¢¼é¢¨æ ¼

- ä½¿ç”¨ **Lombok** æ¸›å°‘æ¨£æ¿ç¨‹å¼ç¢¼
- ä½¿ç”¨ **Builder Pattern** å»ºç«‹ç‰©ä»¶
- å–„ç”¨ **@Transactional** ç®¡ç†äº¤æ˜“
- Controller åªåšåƒæ•¸é©—è­‰ï¼Œæ¥­å‹™é‚è¼¯æ”¾ Service

### 11.3 Git è¦ç¯„

```bash
# Commit è¨Šæ¯æ ¼å¼
[é¡å‹] ç°¡çŸ­æè¿°

feat: æ–°å¢å¥½å‹åˆ—è¡¨æŸ¥è©¢ API
fix: ä¿®æ­£è¨Šæ¯å»é‡æ©Ÿåˆ¶
docs: æ›´æ–° API æ–‡ä»¶
test: æ–°å¢ MessageService æ¸¬è©¦
```

---

## 12. é‡è¦æ³¨æ„äº‹é …

### 12.1 å®‰å…¨æ€§

1. **JWT Secretï¼š** ç”Ÿç”¢ç’°å¢ƒå¿…é ˆä½¿ç”¨å¼·å¯†é‘°ï¼ˆè‡³å°‘ 512 bitsï¼‰
2. **å¯†ç¢¼å¼·åº¦ï¼š** å·²å¯¦ä½œå¯†ç¢¼å¼·åº¦é©—è­‰ï¼Œä¸å¯ç§»é™¤
3. **CORS è¨­å®šï¼š** ç”Ÿç”¢ç’°å¢ƒéœ€é™åˆ¶ä¾†æºç¶²åŸŸ
4. **Rate Limitingï¼š** ç™»å…¥ API å·²æœ‰å¤±æ•—æ¬¡æ•¸é™åˆ¶

### 12.2 æ•ˆèƒ½å„ªåŒ–

1. **è³‡æ–™åº«ç´¢å¼•ï¼š** å·²å»ºç«‹å¿…è¦ç´¢å¼•ï¼Œä¸å¯åˆªé™¤
2. **åˆ†é æŸ¥è©¢ï¼š** æ‰€æœ‰åˆ—è¡¨æŸ¥è©¢éƒ½ä½¿ç”¨åˆ†é 
3. **WebSocket å¿ƒè·³ï¼š** å®¢æˆ¶ç«¯éœ€æ¯ 30 ç§’ç™¼é€ PING

### 12.3 æ•…éšœæ’é™¤

**å¸¸è¦‹å•é¡Œï¼š**

1. **WebSocket é€£ç·šå¤±æ•—**
    - æª¢æŸ¥ Token æ˜¯å¦æœ‰æ•ˆ
    - ç¢ºèª URL æ ¼å¼ï¼š`ws://localhost:8080/ws/chat?token=xxx`

2. **è³‡æ–™åº«é€£ç·šå¤±æ•—**
    - ç¢ºèª Docker å®¹å™¨å·²å•Ÿå‹•ï¼š`docker-compose ps`
    - æª¢æŸ¥ç«¯å£æ˜¯å¦è¢«ä½”ç”¨

3. **æ¸¬è©¦å¤±æ•—**
    - æ¸…ç†è³‡æ–™åº«ï¼š`docker-compose down -v`
    - é‡æ–°å•Ÿå‹•ï¼š`docker-compose up -d`

---

## 13. è¯çµ¡è³‡è¨Š

**äº¤æ¥äººå“¡ï¼š** Claude (AI Assistant)  
**äº¤æ¥æ—¥æœŸï¼š** 2025-10-21  
**å°ˆæ¡ˆç‹€æ…‹ï¼š** é–‹ç™¼ä¸­ï¼ˆå¾Œç«¯ API å·²å®Œæˆ 60%ï¼‰

**ä¸‹ä¸€æ­¥å»ºè­°ï¼š**
1. å¯¦ä½œ Redis Pub/Subï¼ˆPhase 4ï¼‰
2. é–‹ç™¼å‰ç«¯æ‡‰ç”¨
3. é€²è¡Œå£“åŠ›æ¸¬è©¦
4. éƒ¨ç½²è‡³æ¸¬è©¦ç’°å¢ƒ

---

**æ–‡ä»¶çµæŸ** ğŸ“„