# ç‚ºä»€éº¼éœ€è¦ Conversations Collectionï¼Ÿ

## å ´æ™¯ï¼šé¡¯ç¤ºå°è©±åˆ—è¡¨

ä½¿ç”¨è€…æ‰“é–‹èŠå¤© App æ™‚ï¼Œéœ€è¦çœ‹åˆ°ï¼š

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  ğŸŸ¢ Bob Wang           3 åˆ†é˜å‰    â”‚
â”‚  æ™šä¸Šè¦ä¸è¦ä¸€èµ·åƒé£¯ï¼Ÿ      æœªè®€ 3   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸ”´ Charlie Lee        1 å°æ™‚å‰    â”‚
â”‚  å¥½çš„ï¼                æœªè®€ 0      â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚  ğŸŸ¢ David Chen         æ˜¨å¤©        â”‚
â”‚  è¬è¬ä½ çš„å¹«å¿™            æœªè®€ 0     â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## âŒ æ–¹æ¡ˆ Aï¼šåªç”¨ messages Collection

```javascript
// æŸ¥è©¢ä½¿ç”¨è€…çš„æ‰€æœ‰å°è©±
db.messages.aggregate([
  { $match: { 
      $or: [
        { senderId: "alice" },
        { recipientId: "alice" }
      ]
  }},
  { $sort: { timestamp: -1 }},
  { $group: {
      _id: "$conversationId",
      lastMessage: { $first: "$$ROOT" },
      unreadCount: { $sum: { $cond: [
        { $and: [
          { $eq: ["$recipientId", "alice"] },
          { $eq: ["$isRead", false] }
        ]},
        1,
        0
      ]}}
  }},
  { $sort: { "lastMessage.timestamp": -1 }}
])

// å•é¡Œï¼š
// 1. éœ€è¦æƒææ‰€æœ‰è¨Šæ¯ï¼ˆæ•ˆèƒ½å·®ï¼‰
// 2. è¤‡é›œçš„èšåˆæŸ¥è©¢
// 3. ä½¿ç”¨è€…è¨Šæ¯é‡å¤§æ™‚æ¥µæ…¢
```

**æ•ˆèƒ½ï¼š** 10,000 å‰‡è¨Šæ¯ = æŸ¥è©¢æ™‚é–“ç´„ **500ms+** ğŸ˜±

---

## âœ… æ–¹æ¡ˆ Bï¼šä½¿ç”¨ conversations Collection

```javascript
// æŸ¥è©¢å°è©±åˆ—è¡¨
db.conversations.find({
  participants: "uuid-alice"
}).sort({
  updatedAt: -1
}).limit(20)

// å„ªå‹¢ï¼š
// 1. ç›´æ¥æŸ¥è©¢ï¼Œç„¡éœ€èšåˆ
// 2. ç´¢å¼•å„ªåŒ–ï¼ˆparticipants + updatedAtï¼‰
// 3. åªè¿”å› 20 ç­†å°è©±è³‡æ–™
```

**æ•ˆèƒ½ï¼š** 10,000 å‰‡è¨Šæ¯ = æŸ¥è©¢æ™‚é–“ç´„ **5ms** âš¡

---

## è³‡æ–™æ›´æ–°æµç¨‹

### ç•¶ Alice ç™¼é€è¨Šæ¯çµ¦ Bob æ™‚ï¼š

```java
// 1. å„²å­˜è¨Šæ¯åˆ° messages
Message msg = messageRepository.save(newMessage);

// 2. æ›´æ–° conversationsï¼ˆåŸå­æ“ä½œï¼‰
conversationRepository.updateConversation(
  conversationId: "alice_bob",
  lastMessage: {
    messageId: msg.getMessageId(),
    content: msg.getContent(),
    senderId: "alice",
    timestamp: now()
  },
  increment: {
    "unreadCounts.bob": 1    // Bob çš„æœªè®€æ•¸ +1
  },
  updatedAt: now()           // æ›´æ–°æ™‚é–“ï¼ˆç”¨æ–¼æ’åºï¼‰
);
```

### ç•¶ Bob è®€å–è¨Šæ¯æ™‚ï¼š

```java
// 1. æ›´æ–° messages çš„ isRead ç‹€æ…‹
messageRepository.markAsRead(conversationId, recipientId);

// 2. é‡ç½® conversations çš„æœªè®€æ•¸
conversationRepository.resetUnreadCount(conversationId, userId: "bob");
```

---

## ç¸½çµ

| åŠŸèƒ½ | messages | conversations |
|-----|----------|---------------|
| **å„²å­˜å…§å®¹** | å®Œæ•´è¨Šæ¯æ­·å² | å°è©±å…ƒè³‡æ–™ |
| **æŸ¥è©¢é »ç‡** | ä¸­ç­‰ï¼ˆé»é–‹å°è©±æ™‚ï¼‰ | æ¥µé«˜ï¼ˆæ¯æ¬¡æ‰“é–‹ Appï¼‰ |
| **è³‡æ–™é‡** | å¤§ï¼ˆæ•¸ç™¾è¬å‰‡ï¼‰ | å°ï¼ˆç­‰æ–¼å¥½å‹æ•¸ï¼‰ |
| **æ›´æ–°é »ç‡** | æ¥µé«˜ï¼ˆç™¼é€è¨Šæ¯ï¼‰ | é«˜ï¼ˆæ›´æ–°å…ƒè³‡æ–™ï¼‰ |
| **å„ªåŒ–é‡é»** | è¤‡åˆç´¢å¼•ã€åˆ†é  | å¿«é€ŸæŸ¥è©¢ã€å¿«å– |

## è¨­è¨ˆåŸå‰‡

âœ… **è®€å¯«åˆ†é›¢æ€ç¶­**
- `conversations`ï¼šå¿«é€Ÿè®€å–å°è©±åˆ—è¡¨
- `messages`ï¼šå®Œæ•´è¨Šæ¯å„²å­˜

âœ… **ç©ºé–“æ›æ™‚é–“**
- å†—é¤˜ lastMessageï¼Œé¿å…æ¯æ¬¡éƒ½æŸ¥è©¢ messages

âœ… **åŸå­æ›´æ–°**
- ç™¼é€è¨Šæ¯æ™‚åŒæ™‚æ›´æ–°å…©å€‹ Collection
- MongoDB çš„äº‹å‹™æ”¯æ´ï¼ˆ4.0+ï¼‰